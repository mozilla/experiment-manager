{% extends "experiments/detail_base.html" %}

{% block main_sidebar_buttons %}
  {% if experiment.should_use_normandy %}
    <button
      type="submit"
      class="col btn btn-danger mb-3"
      data-toggle="modal"
      data-target="#normandyModal"
      data-ndt-add-class="d-none"
    >
      <span class="fas fa-file-import"></span>
      Send to Normandy
    </button>
  {% endif %}

  <a
    class="d-none col btn btn-primary mb-3"
    data-ndt-remove-class="d-none"
    data-ndt-inject="import-link"
    data-slug="{{ experiment.slug }}"
    target="_blank"
  >
    <span class="fas fa-file-import"></span>
    Send to Normandy
  </a>

  <form
    action="{% url "experiments-status-update" slug=experiment.slug %}"
    method="POST"
  >
    {% csrf_token %}
    <input type="hidden" name="status" value="{{ experiment.STATUS_REVIEW }}">
    <button
      type="submit"
      class="col btn back-status-color mb-4"
    >
      <span class="fas fa-undo"></span>
      Return to Sign-Off
    </button>
  </form>

  <!-- Modal -->
  <div class="modal fade" id="normandyModal" tabindex="-1" role="dialog" aria-labelledby="normandyModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg" role="document">
      <div class="modal-content">

        <div class="modal-header">
          <h5 class="modal-title" id="normandyModalLabel">Normandy Recipe</h5>
          <button type="button" class="close" data-dismiss="modal" aria-label="Close">
            <span aria-hidden="true">&times;</span>
          </button>
        </div>

        <div class="modal-body">
          <div>
            <p>Start by exporting the recipe to Normandy:</p>
            <p>
              <a
                href="{{ experiment.delivery_console_experiment_import_url }}"
                target="_blank"
                class="btn btn-primary"
                role="button"
                id="export-normandy-button"
              >
                Export to Normandy
              </a>
            </p>
          </div>

          <form
            method="post"
            action="{% url "experiments-normandy-update" slug=experiment.slug %}"
            id="id-form"
            class="d-none"
          >
            {% csrf_token %}
            <hr />

            <p>After exporting enter the new recipe ID below:</p>

            <div class="form-group">
              {% include "experiments/field_input_inline.html" with form=normandy_id_form field=normandy_id_form.normandy_id %}
              {% include "experiments/field_errors_inline.html" with form=normandy_id_form field=normandy_id_form.normandy_id %}
            </div>

            <div class="form-group">
              {% include "experiments/field_input_inline.html" with form=normandy_id_form field=normandy_id_form.other_normandy_ids %}
              {% include "experiments/field_errors_inline.html" with form=normandy_id_form field=normandy_id_form.other_normandy_ids %}
            </div>

            <div class="form-group">
              <button type="submit" class="btn btn-success">Save Recipe ID</button>
            </div>
          </form>
        </div>

        <div class="modal-footer">
          <div class="flex-fill">
            <a href="{{ experiment.api_recipe_url }}" target="_blank">Preview Recipe JSON</a>
          </div>
          <div>
            <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
          </div>
        </div>

      </div>
    </div>
  </div>
{% endblock %}

{% block extrascripts %}
  {{ block.super }}
  <script>
    const modal = $("#normandyModal");
    const normandyIdForm = modal.find("#id-form");

    jQuery(function($) {
      $("#export-normandy-button").on("click", function(e) {
        normandyIdForm.removeClass("d-none");
      })
    })
  </script>

  {% if normandy_id_form.errors %}
    <script>
      $(function() {
        normandyIdForm.removeClass("d-none");
        $('#normandyModal').modal();
      });
    </script>
  {% endif %}

{% endblock %}
